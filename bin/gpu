#!/usr/bin/env python3

import core.common as common
import plumbum.cli as cli

from plumbum import local as sh

VGA_SWITCH_PATH = sh.path('/sys/kernel/debug/vgaswitcheroo/switch')


class App(cli.Application):
    '''
        Manages the power state of the MacBook discrete GPU using vgaswitcharoo
    '''

    PROGNAME = 'gpu'
    VERSION = '0.2.0'

    @cli.positional(cli.Set(
        'status',
        'on',
        'off',
        case_sensitive=False,
    ))
    def main(self, command='status'):
        common.check_linux()
        common.check_root()

        if not VGA_SWITCH_PATH.exists():
            print(f'"{VGA_SWITCH_PATH}" doesn\'t exist!')
            print('Are you running Arch on a MacBook Pro?')
            return -1

        if command == 'status':
            print(VGA_SWITCH_PATH.read())
        elif command == 'on':
            VGA_SWITCH_PATH.write('ON')
        else:
            VGA_SWITCH_PATH.write('OFF')


if __name__ == '__main__':
    try:
        App.run()
    except KeyboardInterrupt as e:
        pass
