#!/usr/local/bin/fish

function help
  echo 'Usage: desktop-mount <remote-path> [local-path]'
end

function is_connected_to_vpn
  scutil --nc list | grep 'jeremy-dev-vpn' | grep -q 'Connected'
end

function main -a remote_path -a local_path
  set local_ip '192.168.1.129'
  set remote_ip '4.20.0.2'
  set user 'jeremy'

  if test (uname) != 'Darwin'
    echo 'This command is only supported on macOS.'
    return -1
  end

  if test $argv[1] = 'help'
    help
    return
  end

  if is_connected_to_vpn
    set host $remote_ip
  else
    set host $local_ip
  end

  if test -z $local_path
    set local_path 'shit'
    echo "Using default local path: $local_path"
  end

  mkdir -p $local_path

  if test (ls $local_path | wc -l) -gt 0
    echo "$local_path is not empty!"
    return -1
  end

  sshfs "$user@$host:$remote_path" $local_path
end

main $argv

